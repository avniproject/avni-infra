#!/bin/bash

set -e

BACKUP_DIR="{{ bitwarden_install_dir }}/backups"
DATE=$(date +%Y%m%d_%H%M%S)
RETENTION_DAYS={{ bitwarden_backup_retention_days }}

mkdir -p "$BACKUP_DIR"

logger "Starting Bitwarden backup: $DATE"

cd {{ bitwarden_install_dir }}

echo "Running official Bitwarden backup..."
./bitwarden.sh backup

# Move backup file to organized location
for backup_file in bw_backup_*.tar.gz backup.tar.gz; do
    if [ -f "$backup_file" ]; then
        mv "$backup_file" "$BACKUP_DIR/bitwarden_backup_$DATE.tar.gz"
        echo "Backup moved to: $BACKUP_DIR/bitwarden_backup_$DATE.tar.gz"
        break
    fi
done

# Create backup manifest
cat > "$BACKUP_DIR/backup_manifest_$DATE.txt" << 'EOF'
Official Bitwarden Backup
Domain: {{ bitwarden_domain }}
Created: $(date)
Backup ID: $DATE

Backup Method: Official ./bitwarden.sh backup command
EOF

# Clean old backups
find "$BACKUP_DIR" -name "bitwarden_backup_*.tar.gz" -mtime +$RETENTION_DAYS -delete
find "$BACKUP_DIR" -name "backup_manifest_*.txt" -mtime +$RETENTION_DAYS -delete

echo "Bitwarden backup completed: $DATE"
logger "Bitwarden backup completed: $DATE"